---
title: "metacog_AUROC2vsRegLog"
author: "Embon_Barttfeld_Solovey"
date: "4/6/2022"
output: html_document
---

## Levantar datos y preparo para obtener puntaje de metacog por reg log

```{r levantar datos, echo=TRUE}

# voy a la carpeta del proyecto
root <- rprojroot::is_rstudio_project
basename(getwd())

####### data frames with filters already applied
filepath <- root$find_file("Data/All_exp_exclusion_criteria/df_total.Rda")
load(file= filepath)

source(root$find_file("Analysis/AuxiliaryFunctions/DataFrame_Filtered_already_applied.R"))
DF_list <- DataFrame_Filtered_already_applied(df_total)

# only male and female genders
d <- df_total[df_total$genero == "Masculino" | df_total$genero == "Femenino",]

# modifico las variables que me interesan modificar
d[d == "Masculino"] <- 1
d[d == "Femenino"] <- 0
d$discrimination_is_correct <- ifelse(d$discrimination_is_correct == TRUE, 1, 0)
d$sujetos <- factor(d$sujetos)
d$confidence_key.norm <- (d$confidence_key - 1) / 3 
#d$mc.norm <- (d$mc - mean(d$mc)) / sd(d$mc)
#d$edad.norm <- (d$edad - mean(d$edad)) / sd(d$edad)
#d$AQ.norm <- (d$AQ - mean(d$AQ)) / sd(d$AQ)
#d$AQ_social.norm <- (d$AQ_social - mean(d$AQ_social)) / sd(d$AQ_social)
#d$AQ_atencion_switch.norm  <- (d$AQ_atencion_switch - mean(d$AQ_atencion_switch)) / #sd(d$AQ_atencion_switch)
#d$AQ_atencion_detail.norm <- (d$AQ_atencion_detail - mean(d$AQ_atencion_detail)) / #sd(d$AQ_atencion_detail)
#d$AQ_communication.norm <- (d$AQ_communication - mean(d$AQ_communication)) / sd(d$AQ_communication)
#d$AQ_imagination.norm <- (d$AQ_imagination - mean(d$AQ_imagination)) / sd(d$AQ_imagination)

#print(str(d))
###############
### library ###
###############
library(arm)
library(dplyr)
library(lme4)
library(tibble)
library(ggplot2)
```

## Corro reg log mixta, sujetos variable random, solo varia el slope, intercept fija

```{r reg log, echo=TRUE}


a <- glmer(discrimination_is_correct ~ (0 + confidence_key.norm|sujetos),
           data = d,
           family = binomial,
           control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

# muestro los resultados
print(summary(a))
print(fixef(a))
print(ranef(a))
```

## Visualizacion de los datos

```{r visualizacion reg log, echo=TRUE}

## ploteo los slope ordenados 
library(lattice)
dotplot(ranef(a, which = "sujetos", condVar = TRUE), 
                # con la siguiente linea saco a los sujetos del graf (eje y)
                 scales = list(y = list(alternating = 0)))
                # , main="Sujetos var random",
                # xlab="Confianza")

# guardo metacog de cada sujeto en un df
metacog_log_reg_mixt <-  ranef(a)[["sujetos"]]
```

## Estimo la auroc2 por sujeto

```{r auroc2, echo=TRUE}

root <- rprojroot::is_rstudio_project
basename(getwd())               

####### data frames with filters already applied
filepath <- root$find_file("Data/All_exp_exclusion_criteria/df_total.Rda")
load(file= filepath)

source(root$find_file("Analysis/AuxiliaryFunctions/DataFrame_Filtered_already_applied.R"))
DF_list <- DataFrame_Filtered_already_applied(df_total)

d.sin.normalizar.solo.FyM <- DF_list$d

```

## uno ambos puntajes de metacog en un df y lo exploro

```{r metacog_X2, echo=TRUE}
metacog_x2 <- data.frame(
  sujetos = d.sin.normalizar.solo.FyM$sujetos,
  reg.log.mix.metacog = metacog_log_reg_mixt$confidence_key.norm,
  AUROC2.metacog = d.sin.normalizar.solo.FyM$mc
)

ggplot(metacog_x2, aes(x=reg.log.mix.metacog, y=AUROC2.metacog)) + 
  geom_point()+
  geom_smooth(method=lm)+
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        plot.margin = margin(1, 1,1, 1, "cm"),
        legend.position = 'none',
        legend.text = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(size = 30),
        axis.text.y = element_text(size = 30),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))
```

## Corro reg log mixta, sujetos variable random, varia el slope y el intercept

```{r reg log 2, echo=TRUE}


a2 <- glmer(discrimination_is_correct ~ (1 + confidence_key.norm|sujetos),
           data = d,
           family = binomial,
           control=glmerControl(optimizer="bobyqa",optCtrl=list(maxfun=2e5)))

# muestro los resultados
print(summary(a2))
print(fixef(a2))
print(ranef(a2))
```

## Visualizacion de los datos

```{r visualizacion reg log 2, echo=TRUE}

## ploteo los slope ordenados 
library(lattice)
dotplot(ranef(a2, which = "sujetos", condVar = TRUE), 
                # con la siguiente linea saco a los sujetos del graf (eje y)
                 scales = list(y = list(alternating = 0)))
                # , main="Sujetos var random",
                # xlab="Confianza")

# guardo metacog de cada sujeto en un df
metacog_log_reg_mixt2 <-  ranef(a2)[["sujetos"]]
```

## Lo agrego al df de metacog_x2 y lo exploro

```{r metacog_X2_2, echo=TRUE}
metacog_x2$reg.log.mix.2.metacog <- metacog_log_reg_mixt2$confidence_key.norm

ggplot(metacog_x2, aes(x=reg.log.mix.2.metacog, y=AUROC2.metacog)) + 
  geom_point()+
  geom_smooth(method=lm)+
  theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        plot.margin = margin(1, 1,1, 1, "cm"),
        legend.position = 'none',
        legend.text = element_blank(),
        panel.background = element_blank(),
        axis.text.x = element_text(size = 30),
        axis.text.y = element_text(size = 30),
        axis.title.x = element_text(size = 20),
        axis.title.y = element_text(size = 20))
```

